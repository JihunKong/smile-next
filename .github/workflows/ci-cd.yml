name: Deploy SMILE Next Application

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy-develop'
        type: choice
        options:
          - deploy-develop
          - deploy-pr
      pr_number:
        description: 'PR number (only for deploy-pr action)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/tedahn-pknic/new_smile_flask

# Permissions needed for various actions
permissions:
  contents: read
  pull-requests: read
  packages: write

jobs:
  # 1. Check if we should run at all (path filtering)
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.decide.outputs.should-build }}
      should-deploy: ${{ steps.decide.outputs.should-deploy }}
      should-provision: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.infra == 'true' }}
      is-restore-develop: ${{ steps.decide.outputs.is-restore-develop }}
      # Environment variables calculated once and passed to downstream jobs
      env-name: ${{ steps.vars.outputs.env-name }}
      docker-tag: ${{ steps.vars.outputs.docker-tag }}
      host-port: ${{ steps.vars.outputs.host-port }}
      container-name: ${{ steps.vars.outputs.container-name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for relevant changes
        # Skip path filtering for workflow_dispatch - those are manual triggers
        if: github.event_name != 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # For push events: compare against previous commit on same branch
          # For PR events: compare PR branch against base branch (automatic)
          base: ${{ github.event_name == 'push' && (github.event.before || github.ref) || '' }}
          filters: |
            src:
              - 'src/**'
              - 'public/**'
              - 'package*.json'
              - 'Dockerfile'
              - 'next.config.*'
              - '.env*'
              - 'prisma/**'
            infra:
              - 'scripts/deploy/**'
              - 'docker-compose.*.yml'
              - '.github/workflows/**'

      - name: Decide build/deploy actions
        id: decide
        run: |
          # Default values
          SHOULD_BUILD="false"
          SHOULD_DEPLOY="false"
          IS_RESTORE="false"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.action }}" == "deploy-develop" ]; then
              # Restore develop - skip build, just deploy existing image
              SHOULD_BUILD="false"
              SHOULD_DEPLOY="true"
              IS_RESTORE="true"
            else
              # Deploy specific PR - use existing PR image (no rebuild needed)
              SHOULD_BUILD="false"
              SHOULD_DEPLOY="true"
            fi
          elif [ "${{ steps.filter.outputs.src }}" == "true" ] || [ "${{ steps.filter.outputs.infra }}" == "true" ]; then
            # Push or PR with relevant changes
            SHOULD_BUILD="true"
            SHOULD_DEPLOY="true"
          fi
          
          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is-restore-develop=$IS_RESTORE" >> $GITHUB_OUTPUT

      - name: Set Environment Variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.action }}" == "deploy-develop" ]; then
              # Manual restore: deploy develop image to port 3001
              echo "env-name=dev" >> $GITHUB_OUTPUT
              echo "docker-tag=develop" >> $GITHUB_OUTPUT
              echo "host-port=3001" >> $GITHUB_OUTPUT
              echo "container-name=smile-next-dev" >> $GITHUB_OUTPUT
            else
              # Manual PR deploy: deploy specific PR to port 3001
              echo "env-name=dev" >> $GITHUB_OUTPUT
              echo "docker-tag=pr-${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
              echo "host-port=3001" >> $GITHUB_OUTPUT
              echo "container-name=smile-next-dev" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR: build and deploy to port 3001 (replaces dev)
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "host-port=3001" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=develop" >> $GITHUB_OUTPUT
            echo "host-port=3001" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env-name=prod" >> $GITHUB_OUTPUT
            echo "docker-tag=latest" >> $GITHUB_OUTPUT
            echo "host-port=3000" >> $GITHUB_OUTPUT
            echo "container-name=smile-next" >> $GITHUB_OUTPUT
          fi

  # 2. Provision Infrastructure - Only runs on manual trigger or when infra changes on main branch
  provision-infra:
    needs: check-changes
    if: |
      needs.check-changes.outputs.should-provision == 'true' &&
      (github.event_name == 'workflow_dispatch' || 
       (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    uses: ./.github/workflows/setup-vm.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
    secrets: inherit

  # 3. Call the Reusable Build Workflow
  call-build:
    needs: check-changes
    if: needs.check-changes.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-node.yml
    with:
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit

  # 4. Call Deploy (Dev) - ONLY if on develop branch and push event
  deploy-dev:
    needs: [check-changes, call-build, provision-infra]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/develop' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      needs.check-changes.outputs.should-build == 'true' &&
      needs.call-build.result == 'success' &&
      (needs.provision-infra.result == 'success' || needs.provision-infra.result == 'skipped')
    uses: ./.github/workflows/deploy-gcp-compute-vm-ssh.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
      port: ${{ needs.check-changes.outputs.host-port }}
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      container-name: ${{ needs.check-changes.outputs.container-name }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit

  # 5. Deploy PR - Deploys PR to port 3001 (replaces dev temporarily)
  deploy-pr:
    needs: [check-changes, call-build]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      needs.call-build.result == 'success'
    uses: ./.github/workflows/deploy-gcp-compute-vm-ssh.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
      port: ${{ needs.check-changes.outputs.host-port }}
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      container-name: ${{ needs.check-changes.outputs.container-name }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit

  # 6. Restore Develop - Manual trigger to restore develop after PR testing
  restore-develop:
    needs: [check-changes]
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.action == 'deploy-develop' &&
      needs.check-changes.outputs.is-restore-develop == 'true'
    uses: ./.github/workflows/deploy-gcp-compute-vm-ssh.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
      port: ${{ needs.check-changes.outputs.host-port }}
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      container-name: ${{ needs.check-changes.outputs.container-name }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit

  # 7. Manual PR Deploy - Deploy a specific PR image manually
  manual-pr-deploy:
    needs: [check-changes]
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.action == 'deploy-pr' &&
      inputs.pr_number != ''
    uses: ./.github/workflows/deploy-gcp-compute-vm-ssh.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
      port: ${{ needs.check-changes.outputs.host-port }}
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      container-name: ${{ needs.check-changes.outputs.container-name }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit

  # 8. Call Deploy (Prod) - ONLY if on main branch and push event
  deploy-prod:
    needs: [check-changes, call-build, provision-infra]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      needs.check-changes.outputs.should-build == 'true' &&
      needs.call-build.result == 'success' &&
      (needs.provision-infra.result == 'success' || needs.provision-infra.result == 'skipped')
    uses: ./.github/workflows/deploy-gcp-compute-vm-ssh.yml
    with:
      environment: ${{ needs.check-changes.outputs.env-name }}
      port: ${{ needs.check-changes.outputs.host-port }}
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      container-name: ${{ needs.check-changes.outputs.container-name }}
      image-name: ghcr.io/tedahn-pknic/new_smile_flask
    secrets: inherit
