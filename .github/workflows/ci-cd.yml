name: Deploy SMILE Next Application

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy-pr'
        type: choice
        options:
          - deploy-pr
      pr_number:
        description: 'PR number (required for deploy-pr action)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/seeds-smile-the-ultimate/smile-web

# Permissions needed for various actions
permissions:
  contents: read
  pull-requests: read
  packages: write

jobs:
  # 1. Check if we should run at all (path filtering)
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.decide.outputs.should-build }}
      should-deploy: ${{ steps.decide.outputs.should-deploy }}
      should-provision: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.infra == 'true' }}
      # Environment variables calculated once and passed to downstream jobs
      env-name: ${{ steps.vars.outputs.env-name }}
      docker-tag: ${{ steps.vars.outputs.docker-tag }}
      host-port: ${{ steps.vars.outputs.host-port }}
      container-name: ${{ steps.vars.outputs.container-name }}
      app-url: ${{ steps.vars.outputs.app-url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for relevant changes
        # Skip path filtering for workflow_dispatch - those are manual triggers
        if: github.event_name != 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # For push events: compare against previous commit on same branch
          # For PR events: compare PR branch against base branch (automatic)
          base: ${{ github.event_name == 'push' && (github.event.before || github.ref) || '' }}
          filters: |
            src:
              - 'src/**'
              - 'public/**'
              - 'package*.json'
              - 'Dockerfile'
              - 'next.config.*'
              - '.env*'
              - 'prisma/**'
            infra:
              - 'scripts/deploy/**'
              - 'docker-compose.*.yml'
              - '.github/workflows/**'

      - name: Decide build/deploy actions
        id: decide
        run: |
          # Default values
          SHOULD_BUILD="false"
          SHOULD_DEPLOY="false"
          
          # Determine what changed
          SRC_CHANGED="${{ steps.filter.outputs.src }}"
          INFRA_CHANGED="${{ steps.filter.outputs.infra }}"
          
          echo "ðŸ“‹ Change detection:"
          echo "   Source code changed: $SRC_CHANGED"
          echo "   Infrastructure changed: $INFRA_CHANGED"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual PR deploy - use existing PR image (no rebuild needed)
            SHOULD_BUILD="false"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR with relevant changes
            # SKIP if source branch is 'develop' (to avoid double deploy)
            if [ "${{ github.head_ref }}" == "develop" ]; then
              echo "â„¹ï¸  Skipping PR deploy: source branch is 'develop' (already deployed via push)"
              SHOULD_BUILD="false"
              SHOULD_DEPLOY="false"
            else
              # Build only if source code changed
              if [ "$SRC_CHANGED" == "true" ]; then
                SHOULD_BUILD="true"
                SHOULD_DEPLOY="true"
              elif [ "$INFRA_CHANGED" == "true" ]; then
                # Infra only changed - deploy without rebuild (use existing image)
                SHOULD_BUILD="false"
                SHOULD_DEPLOY="true"
                echo "â„¹ï¸  Infra-only change: will deploy using existing image"
              fi
            fi
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            # Main branch push
            if [ "$SRC_CHANGED" == "true" ]; then
              SHOULD_BUILD="true"
              SHOULD_DEPLOY="true"
            elif [ "$INFRA_CHANGED" == "true" ]; then
              # Infra only - redeploy with existing image
              SHOULD_BUILD="false"
              SHOULD_DEPLOY="true"
              echo "â„¹ï¸  Infra-only change: will deploy using existing image"
            fi
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            # Develop branch push
            if [ "$SRC_CHANGED" == "true" ]; then
              SHOULD_BUILD="true"
              SHOULD_DEPLOY="true"
            elif [ "$INFRA_CHANGED" == "true" ]; then
              # Infra only - redeploy with existing image
              SHOULD_BUILD="false"
              SHOULD_DEPLOY="true"
              echo "â„¹ï¸  Infra-only change: will deploy using existing image"
            fi
          fi
          
          echo ""
          echo "ðŸ“‹ Decision:"
          echo "   should-build: $SHOULD_BUILD"
          echo "   should-deploy: $SHOULD_DEPLOY"
          
          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

      - name: Set Environment Variables
        id: vars
        env:
          # Port configuration from secrets (with defaults matching nginx config)
          # main branch â†’ smilealways.seedsofempowerment.org (port 3001)
          # PR â†’ smilealways-blue.seedsofempowerment.org (port 3002)
          PORT_MAIN: ${{ secrets.VM_PORT_MAIN }}
          PORT_DEV: ${{ secrets.VM_PORT_DEV }}
          PORT_PR: ${{ secrets.VM_PORT_PR }}
        run: |
          # Set default ports if secrets are not configured
          MAIN_PORT="${PORT_MAIN:-3001}"
          DEV_PORT="${PORT_DEV:-3002}"
          PR_PORT="${PORT_PR:-3002}"
          
          echo "ðŸ”§ Port configuration:"
          echo "   MAIN_PORT: $MAIN_PORT"
          echo "   DEV_PORT: $DEV_PORT"
          echo "   PR_PORT: $PR_PORT"
          echo "   Event: ${{ github.event_name }}"
          echo "   Ref: ${{ github.ref }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual PR deploy: deploy specific PR
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=pr-${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "host-port=$PR_PORT" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-pr" >> $GITHUB_OUTPUT
            echo "âœ… Set for workflow_dispatch: port=$PR_PORT"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR: build and deploy to PR port
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "host-port=$PR_PORT" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-pr" >> $GITHUB_OUTPUT
            echo "âœ… Set for pull_request: port=$PR_PORT"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env-name=qa" >> $GITHUB_OUTPUT
            echo "docker-tag=latest" >> $GITHUB_OUTPUT
            echo "host-port=$MAIN_PORT" >> $GITHUB_OUTPUT
            echo "container-name=smile-next" >> $GITHUB_OUTPUT
            echo "âœ… Set for main branch: port=$MAIN_PORT"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=develop" >> $GITHUB_OUTPUT
            echo "host-port=$DEV_PORT" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-dev" >> $GITHUB_OUTPUT
            echo "âœ… Set for develop branch: port=$DEV_PORT"
          else
            echo "âš ï¸  Warning: No matching condition for event=${{ github.event_name }}, ref=${{ github.ref }}"
            echo "   Using default PR port"
            echo "env-name=dev" >> $GITHUB_OUTPUT
            echo "docker-tag=unknown" >> $GITHUB_OUTPUT
            echo "host-port=$PR_PORT" >> $GITHUB_OUTPUT
            echo "container-name=smile-next-pr" >> $GITHUB_OUTPUT
          fi
          
          # Verify outputs were set
          echo ""
          echo "ðŸ“‹ Outputs set:"
          echo "   env-name: $(cat $GITHUB_OUTPUT | grep '^env-name=' | cut -d'=' -f2 || echo 'NOT SET')"
          echo "   docker-tag: $(cat $GITHUB_OUTPUT | grep '^docker-tag=' | cut -d'=' -f2 || echo 'NOT SET')"
          echo "   container-name: $(cat $GITHUB_OUTPUT | grep '^container-name=' | cut -d'=' -f2 || echo 'NOT SET')"

          # Determine APP_URL based on environment
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            APP_URL="https://smilealways.seedsofempowerment.org"
          else
            APP_URL="https://smilealways-blue.seedsofempowerment.org"
          fi
          echo "app-url=$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Set app-url: $APP_URL"

  # 3. Call the Reusable Build Workflow
  call-build:
    needs: check-changes
    if: needs.check-changes.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-node.yml
    with:
      docker-tag: ${{ needs.check-changes.outputs.docker-tag }}
      image-name: ghcr.io/seeds-smile-the-ultimate/smile-web
    secrets: inherit

  # 4. Deploy PR - Deploys PR to port 3002 (smilealways-blue.seedsofempowerment.org)
  deploy-pr:
    needs: [check-changes, call-build]
    runs-on: ubuntu-latest
    environment: ${{ needs.check-changes.outputs.env-name }}
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      (needs.call-build.result == 'success' || needs.call-build.result == 'skipped')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Use GitHub Action for App Token instead of custom script (saves ~30s)
      - name: Get GitHub App Token
        id: github-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}

      - name: Prepare Deployment Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            echo "ðŸ”§ Preparing deployment directory..."
            mkdir -p "$HOME/smile-next"
            # Remove old scripts to ensure clean slate
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true

      - name: Copy Deploy Scripts and Docker Compose Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts,docker-compose.dev.yml,docker-compose.qa.yml,docker-compose.infra.dev.yml"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Execute Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENVIRONMENT: ${{ needs.check-changes.outputs.env-name }}
          DOCKER_TAG: ${{ needs.check-changes.outputs.docker-tag }}
          IMAGE_NAME: ghcr.io/seeds-smile-the-ultimate/smile-web
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
          PORT: ${{ needs.check-changes.outputs.host-port }}
          NEXTAUTH_URL: ${{ needs.check-changes.outputs.app-url }}
          NEXT_PUBLIC_APP_URL: ${{ needs.check-changes.outputs.app-url }}
          GITHUB_TOKEN: ${{ github.token }}
          GHCR_PAT: ${{ steps.github-token.outputs.token }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || 'seeds-smile-the-ultimate' }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENVIRONMENT,DOCKER_TAG,IMAGE_NAME,CONTAINER_NAME,PORT,NEXTAUTH_URL,NEXT_PUBLIC_APP_URL,GITHUB_TOKEN,GHCR_PAT,GHCR_USERNAME
          command_timeout: 120s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/update-app.sh "$ENVIRONMENT" "$DOCKER_TAG" "$IMAGE_NAME" "$CONTAINER_NAME" "$PORT"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CONTAINER_NAME
          command_timeout: 100s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/verify-deployment.sh "$CONTAINER_NAME"

  # 5. Manual PR Deploy - Deploy a specific PR image manually
  manual-pr-deploy:
    needs: [check-changes]
    runs-on: ubuntu-latest
    environment: ${{ needs.check-changes.outputs.env-name }}
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.action == 'deploy-pr' &&
      inputs.pr_number != ''
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Use GitHub Action for App Token instead of custom script (saves ~30s)
      - name: Get GitHub App Token
        id: github-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}

      - name: Prepare & Copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            mkdir -p "$HOME/smile-next"
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true

      - name: Copy Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts,docker-compose.dev.yml,docker-compose.qa.yml,docker-compose.infra.dev.yml"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Execute Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENVIRONMENT: ${{ needs.check-changes.outputs.env-name }}
          DOCKER_TAG: ${{ needs.check-changes.outputs.docker-tag }}
          IMAGE_NAME: ghcr.io/seeds-smile-the-ultimate/smile-web
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
          PORT: ${{ needs.check-changes.outputs.host-port }}
          NEXTAUTH_URL: ${{ needs.check-changes.outputs.app-url }}
          NEXT_PUBLIC_APP_URL: ${{ needs.check-changes.outputs.app-url }}
          GITHUB_TOKEN: ${{ github.token }}
          GHCR_PAT: ${{ steps.github-token.outputs.token }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || 'seeds-smile-the-ultimate' }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENVIRONMENT,DOCKER_TAG,IMAGE_NAME,CONTAINER_NAME,PORT,NEXTAUTH_URL,NEXT_PUBLIC_APP_URL,GITHUB_TOKEN,GHCR_PAT,GHCR_USERNAME
          command_timeout: 120s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/update-app.sh "$ENVIRONMENT" "$DOCKER_TAG" "$IMAGE_NAME" "$CONTAINER_NAME" "$PORT"

  # 6. Call Deploy (QA) - ONLY if on main branch and push event
  deploy-qa:
    needs: [check-changes, call-build]
    runs-on: ubuntu-latest
    environment: ${{ needs.check-changes.outputs.env-name }}
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      (needs.call-build.result == 'success' || needs.call-build.result == 'skipped')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Use GitHub Action for App Token instead of custom script (saves ~30s)
      - name: Get GitHub App Token
        id: github-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}

      - name: Prepare Directory (with diagnostics)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            echo "=== Server Diagnostics ==="
            echo "User: $(whoami)"
            echo "Home: $HOME"
            echo ""
            echo "Disk space:"
            df -h | head -5
            echo ""
            echo "smile-next directory before:"
            ls -la "$HOME/smile-next" 2>/dev/null || echo "Directory does not exist"
            echo ""
            echo "tar version:"
            tar --version | head -1
            echo ""
            echo "Creating directory..."
            mkdir -p "$HOME/smile-next"
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true
            echo ""
            echo "Directory permissions after:"
            ls -la "$HOME/smile-next"
            echo ""
            echo "Write test:"
            touch "$HOME/smile-next/test-write" && echo "Write OK" && rm "$HOME/smile-next/test-write"

      - name: Copy Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts,docker-compose.dev.yml,docker-compose.qa.yml,docker-compose.infra.dev.yml"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Execute Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENVIRONMENT: ${{ needs.check-changes.outputs.env-name }}
          DOCKER_TAG: ${{ needs.check-changes.outputs.docker-tag }}
          IMAGE_NAME: ghcr.io/seeds-smile-the-ultimate/smile-web
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
          PORT: ${{ needs.check-changes.outputs.host-port }}
          NEXTAUTH_URL: ${{ needs.check-changes.outputs.app-url }}
          NEXT_PUBLIC_APP_URL: ${{ needs.check-changes.outputs.app-url }}
          GITHUB_TOKEN: ${{ github.token }}
          GHCR_PAT: ${{ steps.github-token.outputs.token }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || 'seeds-smile-the-ultimate' }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENVIRONMENT,DOCKER_TAG,IMAGE_NAME,CONTAINER_NAME,PORT,NEXTAUTH_URL,NEXT_PUBLIC_APP_URL,GITHUB_TOKEN,GHCR_PAT,GHCR_USERNAME
          command_timeout: 120s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/update-app.sh "$ENVIRONMENT" "$DOCKER_TAG" "$IMAGE_NAME" "$CONTAINER_NAME" "$PORT"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CONTAINER_NAME
          command_timeout: 100s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/verify-deployment.sh "$CONTAINER_NAME"

  # 7. Deploy Dev - Deploys develop branch to port 3002
  deploy-dev:
    needs: [check-changes, call-build]
    runs-on: ubuntu-latest
    environment: ${{ needs.check-changes.outputs.env-name }}
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/develop' &&
      needs.check-changes.outputs.should-deploy == 'true' &&
      (needs.call-build.result == 'success' || needs.call-build.result == 'skipped')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Use GitHub Action for App Token instead of custom script (saves ~30s)
      - name: Get GitHub App Token
        id: github-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}

      - name: Prepare Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            mkdir -p "$HOME/smile-next"
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true

      - name: Copy Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts,docker-compose.dev.yml,docker-compose.qa.yml,docker-compose.infra.dev.yml"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Execute Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENVIRONMENT: ${{ needs.check-changes.outputs.env-name }}
          DOCKER_TAG: ${{ needs.check-changes.outputs.docker-tag }}
          IMAGE_NAME: ghcr.io/seeds-smile-the-ultimate/smile-web
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
          PORT: ${{ needs.check-changes.outputs.host-port }}
          NEXTAUTH_URL: ${{ needs.check-changes.outputs.app-url }}
          NEXT_PUBLIC_APP_URL: ${{ needs.check-changes.outputs.app-url }}
          GITHUB_TOKEN: ${{ github.token }}
          GHCR_PAT: ${{ steps.github-token.outputs.token }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || 'seeds-smile-the-ultimate' }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENVIRONMENT,DOCKER_TAG,IMAGE_NAME,CONTAINER_NAME,PORT,NEXTAUTH_URL,NEXT_PUBLIC_APP_URL,GITHUB_TOKEN,GHCR_PAT,GHCR_USERNAME
          command_timeout: 120s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/update-app.sh "$ENVIRONMENT" "$DOCKER_TAG" "$IMAGE_NAME" "$CONTAINER_NAME" "$PORT"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          CONTAINER_NAME: ${{ needs.check-changes.outputs.container-name }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CONTAINER_NAME
          command_timeout: 100s
          script: |
            cd "$HOME/smile-next" || exit 1
            bash scripts/deploy/verify-deployment.sh "$CONTAINER_NAME"

  # 8. Cleanup old package versions after successful deployment
  cleanup:
    needs: [deploy-qa, deploy-dev, deploy-pr, manual-pr-deploy]
    if: |
      always() &&
      (needs.deploy-qa.result == 'success' || 
       needs.deploy-dev.result == 'success' || 
       needs.deploy-pr.result == 'success' ||
       needs.manual-pr-deploy.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Delete old untagged versions
        uses: actions/delete-package-versions@v5
        continue-on-error: true
        with:
          package-name: 'smile-web'
          package-type: 'container'
          min-versions-to-keep: 5
          delete-only-untagged-versions: 'true'
          owner: 'seeds-smile-the-ultimate'

      - name: Delete old PR versions (older than 7 days)
        uses: actions/delete-package-versions@v5
        continue-on-error: true
        with:
          package-name: 'smile-web'
          package-type: 'container'
          min-versions-to-keep: 10
          ignore-versions: '^(latest|develop)$'
          delete-only-pre-release-versions: 'true'
          owner: 'seeds-smile-the-ultimate'
