name: Deploy to GCP (develop)

on:
  push:
    branches: [ "develop" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/digitalschema/smile-next
  # Host port for the app (blue environment uses 3001)
  APP_HOST_PORT: 3001

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10
          script: |
            # 1. Log in to GHCR if the image is private (set GHCR_PAT; optional GHCR_USERNAME, default digitalschema)
            if [ -n "${{ secrets.GHCR_PAT }}" ]; then
              echo "${{ secrets.GHCR_PAT }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.GHCR_USERNAME || 'digitalschema' }}" --password-stdin
            fi

            # 2. Pull the latest image
            docker pull ${{ env.IMAGE_NAME }}:latest

            # 3. Stop and remove old container ("|| true" so it doesn't fail if not running)
            docker stop smile-next || true
            docker rm smile-next || true

            # 4. Run the new container (env from server; secrets are not in the image)
            # If DB/Redis are on the host, add: --add-host=host.docker.internal:host-gateway
            # and set DATABASE_URL/REDIS_URL in .env to use host.docker.internal
            docker run -d \
              --name smile-next \
              --restart always \
              -p ${{ env.APP_HOST_PORT }}:3000 \
              --env-file /opt/smile-next/.env \
              ${{ env.IMAGE_NAME }}:latest

            # 5. Clean up dangling images to save disk space
            docker image prune -f