name: Deploy to GCP Compute VM via SSH

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      port:
        required: true
        type: string
      docker-tag:
        required: true
        type: string
      container-name:
        required: true
        type: string
      image-name:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Verify build succeeded
        run: |
          echo "âœ… Build verification passed - proceeding with deployment"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify GitHub App Secrets
        env:
          DEPLOYER_APP_ID: ${{ secrets.DEPLOYER_APP_ID }}
          DEPLOYER_APP_INSTALLATION_ID: ${{ secrets.DEPLOYER_APP_INSTALLATION_ID }}
          DEPLOYER_APP_PRIVATE_KEY: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}
        run: |
          if [ -z "$DEPLOYER_APP_ID" ]; then
            echo "âŒ DEPLOYER_APP_ID is not set"
            exit 1
          fi
          if [ -z "$DEPLOYER_APP_INSTALLATION_ID" ]; then
            echo "âŒ DEPLOYER_APP_INSTALLATION_ID is not set"
            exit 1
          fi
          if [ -z "$DEPLOYER_APP_PRIVATE_KEY" ]; then
            echo "âŒ DEPLOYER_APP_PRIVATE_KEY is not set"
            exit 1
          fi
          echo "âœ… All GitHub App secrets are set"
          echo "DEPLOYER_APP_ID length: ${#DEPLOYER_APP_ID}"
          echo "DEPLOYER_APP_INSTALLATION_ID length: ${#DEPLOYER_APP_INSTALLATION_ID}"
          echo "DEPLOYER_APP_PRIVATE_KEY length: ${#DEPLOYER_APP_PRIVATE_KEY}"

      - name: Get GitHub App Token
        id: github-token
        env:
          DEPLOYER_APP_ID: ${{ secrets.DEPLOYER_APP_ID }}
          DEPLOYER_APP_INSTALLATION_ID: ${{ secrets.DEPLOYER_APP_INSTALLATION_ID }}
          DEPLOYER_APP_PRIVATE_KEY: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}
        run: |
          TOKEN=$(npx tsx scripts/github/get-github-app-token.ts)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          # Mask token in logs for security
          echo "::add-mask::$TOKEN"

      - name: Prepare Deployment Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            echo "ðŸ”§ Preparing deployment directory..."
            mkdir -p "$HOME/smile-next"
            # Only remove scripts directory, preserve .env and other files
            echo "ðŸ”’ Preserving .env file and other non-script files..."
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true
            
            # Verify .env file is preserved (if it exists)
            if [ -f "$HOME/smile-next/.env" ]; then
              echo "âœ… Found .env file in $HOME/smile-next (will be preserved)"
            fi

      - name: Copy Deploy Scripts and Docker Compose Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts,docker-compose.dev.yml,docker-compose.prod.yml"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Execute Lean Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 120s
          script: |
            export ENVIRONMENT="${{ inputs.environment }}"
            export DOCKER_TAG="${{ inputs.docker-tag }}"
            export IMAGE_NAME="${{ inputs.image-name }}"
            export CONTAINER_NAME="${{ inputs.container-name }}"
            export PORT="${{ inputs.port }}"
            # Use GITHUB_TOKEN (same as build workflow) - better for org-level packages
            # Fall back to GitHub App token if GITHUB_TOKEN not available
            export GITHUB_TOKEN="${{ github.token }}"
            export GHCR_PAT="${{ steps.github-token.outputs.token }}"
            export GHCR_USERNAME="${{ secrets.GHCR_USERNAME || 'seeds-smile-the-ultimate' }}"
            
            cd "$HOME/smile-next" || { echo "ERROR: $HOME/smile-next not found"; exit 1; }
            bash scripts/deploy/update-app.sh "$ENVIRONMENT" "$DOCKER_TAG" "$IMAGE_NAME" "$CONTAINER_NAME" "$PORT"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            cd "$HOME/smile-next" || { echo "ERROR: $HOME/smile-next not found"; exit 1; }
            export ENVIRONMENT="${{ inputs.environment }}"
            bash scripts/deploy/verify-deployment.sh "${{ inputs.container-name }}"
