name: Deploy to GCP Compute VM via SSH

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      port:
        required: true
        type: string
      docker-tag:
        required: true
        type: string
      container-name:
        required: true
        type: string
      image-name:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Verify build succeeded
        run: |
          echo "âœ… Build verification passed - proceeding with deployment"

      - name: Validate Environment Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            cd /opt/smile-next || cd ~/new_smile_flask || exit 1
            bash scripts/deploy/validate-env.sh ${{ inputs.environment }}

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60s
          script: |
            cd /opt/smile-next || cd ~/new_smile_flask || exit 1
            
            # Ensure dependency containers are running
            bash scripts/deploy/ensure-dependencies.sh ${{ inputs.environment }}
            
            # Deploy the application
            bash scripts/deploy/deploy-app.sh \
              "${{ inputs.image-name }}" \
              "${{ inputs.docker-tag }}" \
              "${{ inputs.port }}" \
              "${{ inputs.container-name }}" \
              "${{ secrets.GHCR_USERNAME || 'tedahn-pknic' }}" \
              "${{ secrets.GHCR_PAT }}"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            cd /opt/smile-next || cd ~/new_smile_flask || exit 1
            bash scripts/deploy/verify-deployment.sh "${{ inputs.container-name }}"
