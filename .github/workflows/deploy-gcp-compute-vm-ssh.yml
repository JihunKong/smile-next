name: Deploy to GCP Compute VM via SSH

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      port:
        required: true
        type: string
      docker-tag:
        required: true
        type: string
      container-name:
        required: true
        type: string
      image-name:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Verify build succeeded
        run: |
          echo "‚úÖ Build verification passed - proceeding with deployment"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Deployment Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            echo "üîß Preparing deployment directory..."
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            
            # Try to create/clean /home/deployer/smile-next if we have permission
            if mkdir -p /home/deployer/smile-next 2>/dev/null && [ -w /home/deployer/smile-next ] 2>/dev/null; then
              echo "‚úÖ Can write to /home/deployer/smile-next"
              echo "üìÅ Cleaning /home/deployer/smile-next..."
              rm -rf /home/deployer/smile-next/* /home/deployer/smile-next/.* 2>/dev/null || true
            else
              echo "‚ö†Ô∏è  Cannot write to /home/deployer/smile-next (permission denied)"
              echo "üìÅ Will use user home directory: $HOME/smile-next"
            fi
            
            # Always prepare user home directory as fallback
            echo "üìÅ Preparing $HOME/smile-next..."
            mkdir -p "$HOME/smile-next"
            rm -rf "$HOME/smile-next"/* "$HOME/smile-next"/.* 2>/dev/null || true
            
            # Show permissions for debugging
            echo "üìÇ Directory permissions:"
            ls -la /home/deployer/ 2>/dev/null | head -5 || echo "  Cannot access /home/deployer/"
            ls -la "$HOME/" | grep smile-next || echo "  $HOME/smile-next ready"

      - name: Copy Deploy Scripts to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Move Scripts to Deployer Directory (if permitted)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            echo "üîÑ Attempting to move scripts to /home/deployer/smile-next..."
            if [ -d "$HOME/smile-next" ]; then
              # Try to copy to /home/deployer if we have permission
              if mkdir -p /home/deployer/smile-next 2>/dev/null && [ -w /home/deployer/smile-next ] 2>/dev/null; then
                echo "‚úÖ Copying to /home/deployer/smile-next..."
                cp -r "$HOME/smile-next"/* /home/deployer/smile-next/ 2>/dev/null && \
                echo "‚úÖ Successfully copied to /home/deployer/smile-next" || \
                echo "‚ö†Ô∏è  Copy failed, will use $HOME/smile-next"
              else
                echo "‚ö†Ô∏è  Cannot write to /home/deployer/smile-next, using $HOME/smile-next"
              fi
            else
              echo "‚ùå Source directory $HOME/smile-next not found"
              exit 1
            fi

      - name: Validate Environment Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            cd /home/deployer/smile-next || cd ~/smile-next || cd $HOME/new_smile_flask || cd /opt/smile-next || { echo "ERROR: Scripts directory not found"; exit 1; }
            bash scripts/deploy/validate-env.sh ${{ inputs.environment }}

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60s
          script: |
            cd /home/deployer/smile-next || cd ~/smile-next || cd $HOME/new_smile_flask || cd /opt/smile-next || { echo "ERROR: Scripts directory not found"; exit 1; }
            
            # Ensure dependency containers are running
            bash scripts/deploy/ensure-dependencies.sh ${{ inputs.environment }}
            
            # Deploy the application
            bash scripts/deploy/deploy-app.sh \
              "${{ inputs.image-name }}" \
              "${{ inputs.docker-tag }}" \
              "${{ inputs.port }}" \
              "${{ inputs.container-name }}" \
              "${{ secrets.GHCR_USERNAME || 'tedahn-pknic' }}" \
              "${{ secrets.GHCR_PAT }}"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            cd /home/deployer/smile-next || cd ~/smile-next || cd $HOME/new_smile_flask || cd /opt/smile-next || { echo "ERROR: Scripts directory not found"; exit 1; }
            bash scripts/deploy/verify-deployment.sh "${{ inputs.container-name }}"
