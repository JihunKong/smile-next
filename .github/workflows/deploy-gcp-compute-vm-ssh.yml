name: Deploy to GCP Compute VM via SSH

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      port:
        required: true
        type: string
      docker-tag:
        required: true
        type: string
      container-name:
        required: true
        type: string
      image-name:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Verify build succeeded
        run: |
          echo "âœ… Build verification passed - proceeding with deployment"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Deployment Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            echo "ðŸ”§ Preparing deployment directory..."
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            
            # Prepare user home directory
            echo "ðŸ“ Preparing $HOME/smile-next..."
            mkdir -p "$HOME/smile-next"
            # Only remove scripts directory, preserve .env and other files
            echo "ðŸ”’ Preserving .env file and other non-script files..."
            rm -rf "$HOME/smile-next/scripts" 2>/dev/null || true
            
            # Verify .env file is preserved (if it exists)
            if [ -f "$HOME/smile-next/.env" ]; then
              echo "âœ… Found .env file in $HOME/smile-next (will be preserved)"
            fi

      - name: Copy Deploy Scripts to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts"
          target: "~/smile-next"
          rm: false
          debug: true

      - name: Validate Environment Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            cd "$HOME/smile-next" || { echo "ERROR: $HOME/smile-next not found"; exit 1; }
            bash scripts/deploy/validate-env.sh ${{ inputs.environment }}

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60s
          script: |
            cd "$HOME/smile-next" || { echo "ERROR: $HOME/smile-next not found"; exit 1; }
            
            # Ensure dependency containers are running
            bash scripts/deploy/ensure-dependencies.sh ${{ inputs.environment }}
            
            # Deploy the application
            bash scripts/deploy/deploy-app.sh \
              "${{ inputs.image-name }}" \
              "${{ inputs.docker-tag }}" \
              "${{ inputs.port }}" \
              "${{ inputs.container-name }}" \
              "${{ secrets.GHCR_USERNAME || 'tedahn-pknic' }}" \
              "${{ secrets.GHCR_PAT }}"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            cd "$HOME/smile-next" || { echo "ERROR: $HOME/smile-next not found"; exit 1; }
            bash scripts/deploy/verify-deployment.sh "${{ inputs.container-name }}"
