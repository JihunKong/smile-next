name: Deploy to GCP Compute VM via SSH

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      port:
        required: true
        type: string
      docker-tag:
        required: true
        type: string
      container-name:
        required: true
        type: string
      image-name:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Verify build succeeded
        run: |
          echo "‚úÖ Build verification passed - proceeding with deployment"

      - name: Setup and Update Code on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60s
          script: |
            # Determine repository URL and branch
            REPO_URL="https://github.com/${{ github.repository }}.git"
            # Determine branch based on environment
            if [ "${{ inputs.environment }}" == "dev" ]; then
              BRANCH="develop"
            else
              BRANCH="main"
            fi
            
            # Preferred directory: /opt/smile-next, fallback: ~/new_smile_flask
            if [ -d "/opt/smile-next" ]; then
              REPO_DIR="/opt/smile-next"
            elif [ -d "$HOME/new_smile_flask" ]; then
              REPO_DIR="$HOME/new_smile_flask"
            else
              # Create directory and clone repository
              echo "üì¶ Repository not found. Cloning to ~/new_smile_flask..."
              mkdir -p $HOME/new_smile_flask
              cd $HOME
              git clone -b $BRANCH $REPO_URL new_smile_flask || {
                echo "‚ö†Ô∏è  Failed to clone $BRANCH branch, trying main..."
                git clone -b main $REPO_URL new_smile_flask || {
                  echo "‚ùå Failed to clone repository"
                  exit 1
                }
              }
              REPO_DIR="$HOME/new_smile_flask"
            fi
            
            # Update repository
            echo "üîÑ Updating repository at $REPO_DIR..."
            cd $REPO_DIR
            git fetch origin
            git checkout $BRANCH || git checkout main
            git pull origin $BRANCH || git pull origin main || echo "‚ö†Ô∏è  Warning: git pull failed, continuing with existing code..."
            
            echo "‚úÖ Repository ready at $REPO_DIR"

      - name: Validate Environment Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10s
          script: |
            # Find repository directory
            if [ -d "/opt/smile-next" ]; then
              cd /opt/smile-next
            elif [ -d "$HOME/new_smile_flask" ]; then
              cd $HOME/new_smile_flask
            else
              echo "ERROR: Repository directory not found"
              exit 1
            fi
            bash scripts/deploy/validate-env.sh ${{ inputs.environment }}

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60s
          script: |
            # Find repository directory
            if [ -d "/opt/smile-next" ]; then
              cd /opt/smile-next
            elif [ -d "$HOME/new_smile_flask" ]; then
              cd $HOME/new_smile_flask
            else
              echo "ERROR: Repository directory not found"
              exit 1
            fi
            
            # Ensure dependency containers are running
            bash scripts/deploy/ensure-dependencies.sh ${{ inputs.environment }}
            
            # Deploy the application
            bash scripts/deploy/deploy-app.sh \
              "${{ inputs.image-name }}" \
              "${{ inputs.docker-tag }}" \
              "${{ inputs.port }}" \
              "${{ inputs.container-name }}" \
              "${{ secrets.GHCR_USERNAME || 'tedahn-pknic' }}" \
              "${{ secrets.GHCR_PAT }}"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30s
          script: |
            # Find repository directory
            if [ -d "/opt/smile-next" ]; then
              cd /opt/smile-next
            elif [ -d "$HOME/new_smile_flask" ]; then
              cd $HOME/new_smile_flask
            else
              echo "ERROR: Repository directory not found"
              exit 1
            fi
            bash scripts/deploy/verify-deployment.sh "${{ inputs.container-name }}"
